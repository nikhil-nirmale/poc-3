# ğŸ·ï¸ Name of the workflow as seen in the GitHub Actions UI
name: Deploy Flask Services

# ğŸŸ¢ Trigger this workflow only when pushing to the `main` branch
on:
  push:
    branches: [main]

jobs:
  deploy:
    # ğŸ–¥ï¸ Runs on GitHub-hosted Ubuntu runner
    runs-on: ubuntu-latest

    steps:
      # âœ… Step 1: Checkout the repo code to the runner
      # ğŸ” Needed to access Dockerfiles and changed files
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # â³ Keeps last 2 commits so we can detect file changes

      # âœ… Step 2: Authenticate to Google Cloud using service account credentials
      # ğŸ” Uses a secret `GCP_CREDENTIALS` you already added in repo secrets
      # ğŸ¯ Required for pushing to Artifact Registry
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      # âœ… Step 3: Set up Docker to use GCP Artifact Registry
      # ğŸ› ï¸ This command allows `docker push` to work with your private GAR repo
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

      # âœ… Step 4: Detect which service directories have changed
      # ğŸ“ Assumes services are in folders like `s-1`, `s-2`, etc.
      # ğŸ” Uses `git diff` to find which service folders changed in this commit
      - name: Detect changed services
        id: detect
        run: |
          echo "CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | grep '^s-' | cut -d/ -f1 | sort -u | tr '\n' ' ')" >> $GITHUB_ENV
          
          # ğŸ” Breakdown:
          # - `git diff --name-only HEAD^ HEAD` â†’ list of changed files
          # - `grep '^s-'` â†’ only files inside s-1/, s-2/, etc.
          # - `cut -d/ -f1` â†’ get top-level folder name
          # - `sort -u` + `tr` â†’ unique list in space-separated format
          # â†’ Output: CHANGED_DIRS="s-1 s-3"

      # âœ… Step 5: For each changed service, build and push its Docker image
      - name: Build and push images with Git SHA tag
        run: |
          for dir in $CHANGED_DIRS; do
            echo "ğŸš€ Building and pushing: $dir"

            # # ğŸ†” Use timestamp + short Git commit SHA for tag
            TAG="$(date +%Y%m%d-%H%M%S)-$(echo $GITHUB_SHA | cut -c1-7)"

            # ğŸ·ï¸ Compose the full image name (hardcoded registry, repo, and service name)
            IMAGE="europe-west1-docker.pkg.dev/poc-setup-462605/poc-docker-repo/$dir"

            # ğŸ› ï¸ Build Docker image with two tags:
            # - $TAG: uniquely identifies this build
            # - latest: optional tag if you want to keep latest pointer
            docker build -t $IMAGE:$TAG -t $IMAGE:latest $dir

            # ğŸš€ Push both tags to Google Artifact Registry
            docker push $IMAGE:$TAG
            docker push $IMAGE:latest
          done
